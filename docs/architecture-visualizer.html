<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture Muwasala - Diagrammes Mermaid</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-left: 10px;
            border-left: 4px solid #3498db;
        }
        .diagram-container {
            margin: 20px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .mermaid {
            text-align: center;
        }
        .description {
            margin-bottom: 15px;
            padding: 10px;
            background: #e8f4fd;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèóÔ∏è Architecture Muwasala Islamic Knowledge Network</h1>

        <h2>1. Architecture Globale du Syst√®me</h2>
        <div class="description">
            Vue d'ensemble des couches principales : Pr√©sentation, Application, et Donn√©es avec leurs interconnexions.
        </div>
        <div class="diagram-container">
            <div class="mermaid">
graph TB
    subgraph "Couche Pr√©sentation"
        WEB[Muwasala.Web<br/>Blazor Server]
        API[Muwasala.Api<br/>REST API]
        CLI[Muwasala.Console<br/>CLI Interface]
        MCP[Muwasala.MCP<br/>Model Context Protocol]
    end

    subgraph "Couche Application"
        CORE[Muwasala.Core<br/>Core Services]
        AGENTS[Muwasala.Agents<br/>Multi-Agent System]
    end

    subgraph "Couche Donn√©es"
        KB[Muwasala.KnowledgeBase<br/>Islamic Knowledge Services]
        DB[(SQLite Database)]
        ES[(Elasticsearch)]
        FILES[JSON Files<br/>Quran & Hadith]
    end

    subgraph "Services Externes"
        OLLAMA[Ollama AI<br/>DeepSeek Models]
        PHI3[Phi-3 AI<br/>Enhanced Processing ‚≠ê]
        SUNNAH[Sunnah.com API]
        WEB_SOURCES[Islamic Web Sources]
    end

    %% Connections
    WEB --> CORE
    API --> CORE
    CLI --> CORE
    MCP --> CORE
    
    CORE --> AGENTS
    CORE --> KB
    
    AGENTS --> OLLAMA
    AGENTS --> PHI3
    AGENTS --> SUNNAH
    AGENTS --> WEB_SOURCES
    
    KB --> DB
    KB --> ES
    KB --> FILES

    %% Styling
    classDef presentation fill:#e1f5fe
    classDef application fill:#f3e5f5
    classDef data fill:#e8f5e8
    classDef external fill:#fff3e0
    
    class WEB,API,CLI,MCP presentation
    class CORE,AGENTS application
    class KB,DB,ES,FILES data
    class OLLAMA,PHI3,SUNNAH,WEB_SOURCES external
            </div>
        </div>

        <h2>2. Architecture Multi-Agents</h2>
        <div class="description">
            Syst√®me d'agents sp√©cialis√©s orchestr√© par DeepSeek Brain pour r√©pondre aux questions islamiques.
        </div>
        <div class="diagram-container">
            <div class="mermaid">
graph LR
    subgraph "DeepSeek Brain Agent"
        BRAIN[DeepSeek Brain<br/>Central Orchestrator]
    end
    
    subgraph "Agents Sp√©cialis√©s"
        QNA[Quran Navigator<br/>Agent]
        HVA[Hadith Verifier<br/>Agent]
        FIA[Enhanced Fiqh Advisor<br/>Agent ‚≠ê]
        DCA[Dua Companion<br/>Agent]
        TTA[Tajweed Tutor<br/>Agent]
        SSA[Sirah Scholar<br/>Agent]
        WCA[Web Crawler<br/>Agent]
        QAA[AI Query Analysis<br/>Agent]
        RQA[Response Quality<br/>Agent]
        RTS[Real-Time Search<br/>Agent]
        TSA[Text Summarization<br/>Agent]
        CSA[Context Search<br/>Agent]
    end

    subgraph "Services de Support"
        HYBRID[Enhanced Hybrid<br/>Search Service]
        FALLBACK[Fast Fallback<br/>Service]
        CIRCUIT[Circuit Breaker<br/>Service]
        ENHANCED[Enhanced Fiqh<br/>Service ‚≠ê]
        PHI3_SVC[Phi-3 AI Integration<br/>Service]
        VECTOR[Vector Similarity<br/>Service]
        SEMANTIC[Semantic Analysis<br/>Service]
    end

    USER[üë§ Utilisateur] --> BRAIN
    BRAIN --> QNA
    BRAIN --> HVA
    BRAIN --> FIA
    BRAIN --> DCA
    BRAIN --> TTA
    BRAIN --> SSA
    BRAIN --> WCA
    BRAIN --> QAA
    BRAIN --> RQA
    BRAIN --> RTS
    BRAIN --> TSA
    BRAIN --> CSA
    
    QNA --> HYBRID
    HVA --> HYBRID
    FIA --> ENHANCED
    FIA --> PHI3_SVC
    FIA --> VECTOR
    FIA --> SEMANTIC
    
    ENHANCED --> HYBRID
    HYBRID --> FALLBACK
    FALLBACK --> CIRCUIT
    
    BRAIN --> USER

    %% Styling
    classDef brain fill:#ff6b6b
    classDef agents fill:#4ecdc4
    classDef services fill:#45b7d1
    classDef user fill:#96ceb4
    
    class BRAIN brain
    class QNA,HVA,FIA,DCA,TTA,SSA,WCA,QAA,RQA,RTS,TSA,CSA agents
    class HYBRID,FALLBACK,CIRCUIT,ENHANCED,PHI3_SVC,VECTOR,SEMANTIC services
    class USER user
            </div>
        </div>

        <h2>3. Flux Enhanced Fiqh Advisor ‚≠ê</h2>
        <div class="description">
            Nouveau syst√®me de consultation jurisprudentielle islamique avec IA avanc√©e - processus complet de traitement des questions Fiqh.
        </div>
        <div class="diagram-container">
            <div class="mermaid">
sequenceDiagram
    participant U as Utilisateur
    participant W as Blazor Web
    participant EFC as Enhanced Fiqh Controller
    participant EFS as Enhanced Fiqh Service
    participant EFA as Enhanced Fiqh Agent
    participant PHI as Phi-3 AI Service
    participant VES as Vector Embedding Service
    participant IKS as Islamic Knowledge Service
    participant DB as Database

    U->>W: Question Fiqh: "Is cryptocurrency halal?"
    W->>EFC: POST /api/enhanced-fiqh/ask
    EFC->>EFS: ProcessQuestionAsync()
    
    EFS->>EFA: AnalyzeQuestionAsync()
    EFA->>PHI: Analyze question context
    PHI-->>EFA: Question analysis result
    
    par Recherche de preuves parall√®le
        EFA->>VES: Search relevant verses
        EFA->>IKS: Search relevant hadiths
        EFA->>IKS: Search scholarly opinions
    end
    
    VES-->>EFA: Quran verses
    IKS-->>EFA: Hadith evidences
    IKS-->>EFA: Scholarly references
    
    EFA->>PHI: Generate comprehensive response
    PHI-->>EFA: AI-enhanced response
    
    EFA->>EFS: Format final response
    EFS->>EFC: EnhancedFiqhResponse
    EFC->>W: JSON with structured answer
    W->>U: Display comprehensive Fiqh guidance
    
    Note over U,DB: Response includes: Main ruling, evidence,<br/>school differences, practical guidance
            </div>
        </div>

        <h2>4. Flux de Recherche Classique</h2>
        <div class="description">
            S√©quence de traitement d'une recherche "moon" de l'utilisateur jusqu'aux r√©sultats finaux.
        </div>
        <div class="diagram-container">
            <div class="mermaid">
sequenceDiagram
    participant U as Utilisateur
    participant W as Web Interface
    participant A as API Controller
    participant B as DeepSeek Brain
    participant H as Hybrid Search
    participant S as SQLite
    participant E as Elasticsearch
    participant F as Fallback Service

    U->>W: Recherche "moon"
    W->>A: POST /api/hadith/search
    A->>B: Analyser la requ√™te
    B->>H: Recherche hybride
    
    par Recherche parall√®le
        H->>S: Recherche SQLite
        H->>E: Recherche Elasticsearch
    end
    
    alt Elasticsearch disponible
        E-->>H: R√©sultats Elasticsearch
        H->>B: R√©sultats principaux
    else Elasticsearch indisponible
        S-->>H: R√©sultats SQLite
        H->>F: Service de secours
        F->>B: R√©sultats de secours
    end
    
    B->>A: R√©sultats enrichis
    A->>W: JSON Response
    W->>U: Affichage des r√©sultats
            </div>
        </div>

        <h2>5. Architecture des Donn√©es</h2>
        <div class="description">
            Structure des donn√©es islamiques et leurs services d'acc√®s dans le syst√®me, avec les nouveaux mod√®les Enhanced Fiqh.
        </div>
        <div class="diagram-container">
            <div class="mermaid">
graph TB
    subgraph "Sources de Donn√©es"
        QF[Quran Files<br/>114 Sourates]
        HF[Hadith Collections<br/>Bukhari, Muslim, etc.]
        AF[Additional Resources<br/>Duas, Fiqh, etc.]
    end

    subgraph "Couche de Persistance"
        SQLITE[(SQLite Database<br/>HadithRecords<br/>QuranVerses)]
        ELASTIC[(Elasticsearch<br/>Index: hadiths<br/>Full-text search)]
        CACHE[Memory Cache<br/>Fast access]
    end

    subgraph "Services d'Acc√®s aux Donn√©es"
        IKS[Islamic Knowledge<br/>Service]
        HSS[Hadith Search<br/>Service]
        ESS[Elasticsearch<br/>Service]
        AHS[Advanced Hadith<br/>Search Service]
        EFS[Enhanced Fiqh<br/>Service ‚≠ê]
        VES[Vector Embedding<br/>Service]
        SAS[Semantic Analysis<br/>Service]
    end

    subgraph "Mod√®les de Donn√©es"
        QV[QuranVerse]
        HR[HadithRecord]
        SH[ScoredHadith]
        SR[SearchResult]
        EFR[EnhancedFiqhResponse ‚≠ê]
        EFQ[EnhancedFiqhQuestion]
        FE[FiqhEvidence]
        SchR[SchoolRuling]
    end

    %% Data Flow
    QF --> SQLITE
    HF --> SQLITE
    AF --> SQLITE
    
    HF --> ELASTIC
    
    SQLITE --> IKS
    ELASTIC --> ESS
    CACHE --> IKS
    
    IKS --> HSS
    ESS --> AHS
    HSS --> AHS
    EFS --> VES
    EFS --> SAS
    
    AHS --> QV
    AHS --> HR
    AHS --> SH
    AHS --> SR
    EFS --> EFR
    EFS --> EFQ
    EFS --> FE
    EFS --> SchR

    %% Styling
    classDef sources fill:#ffeb3b
    classDef persistence fill:#4caf50
    classDef services fill:#2196f3
    classDef models fill:#9c27b0
    
    class QF,HF,AF sources
    class SQLITE,ELASTIC,CACHE persistence
    class IKS,HSS,ESS,AHS,EFS,VES,SAS services
    class QV,HR,SH,SR,EFR,EFQ,FE,SchR models
            </div>
        </div>

        <h2>6. Technologies Utilis√©es</h2>
        <div class="description">
            Vue d'ensemble des technologies et frameworks utilis√©s dans le projet, incluant les nouvelles int√©grations IA.
        </div>
        <div class="diagram-container">
            <div class="mermaid">
mindmap
  root((Muwasala<br/>Tech Stack))
    Backend
      ASP.NET Core 8
      Entity Framework Core
      SQLite Database
      Elasticsearch 8.12
      Swagger/OpenAPI
    Frontend
      Blazor Server
      Enhanced Fiqh UI ‚≠ê
      HTML/CSS/JavaScript
      Bootstrap
      Chart.js
    AI/ML
      Ollama
      Phi-3 Integration ‚≠ê
      DeepSeek Models
      Vector Search
      Semantic Analysis
    DevOps
      Git/GitHub
      Docker
      CI/CD Pipelines
      Monitoring
    Testing
      xUnit
      Integration Tests
      Performance Tests
      Load Testing
            </div>
        </div>

        <h2>7. Architecture Enhanced Fiqh Advisor ‚≠ê</h2>
        <div class="description">
            Architecture d√©taill√©e du nouveau syst√®me Enhanced Fiqh Advisor avec int√©gration Phi-3 et services avanc√©s.
        </div>
        <div class="diagram-container">
            <div class="mermaid">
graph TB
    subgraph "Interface Utilisateur"
        UI[Enhanced Fiqh Page<br/>Blazor UI]
        TEMPLATES[Question Templates<br/>Prayer, Fasting, Marriage, etc.]
        CHAT[Interactive Chat Interface]
    end

    subgraph "Couche de Traitement"
        CONTROLLER[Enhanced Fiqh Controller<br/>API Endpoint]
        SERVICE[Enhanced Fiqh Service<br/>Business Logic]
        AGENT[Enhanced Fiqh Agent<br/>AI Orchestration]
    end

    subgraph "Intelligence Artificielle"
        PHI3[Phi-3 Mini Model<br/>3.8B Parameters]
        ANALYSIS[Question Analysis<br/>Context Understanding]
        GENERATION[Response Generation<br/>Structured Output]
    end

    subgraph "Base de Connaissances"
        QURAN[Quran Verses<br/>114 Suras]
        HADITH[Hadith Collections<br/>6 Major Books]
        FIQH[Fiqh Rules<br/>4 Schools of Thought]
        SCHOLARS[Scholarly Opinions<br/>Historical & Contemporary]
    end

    subgraph "Services de Support"
        VECTOR[Vector Similarity<br/>Semantic Search]
        EMBEDDING[Text Embedding<br/>Multilingual Support]
        CACHE[Response Caching<br/>Performance Optimization]
    end

    UI --> CONTROLLER
    TEMPLATES --> UI
    CHAT --> UI
    
    CONTROLLER --> SERVICE
    SERVICE --> AGENT
    
    AGENT --> PHI3
    AGENT --> ANALYSIS
    AGENT --> GENERATION
    
    AGENT --> QURAN
    AGENT --> HADITH
    AGENT --> FIQH
    AGENT --> SCHOLARS
    
    AGENT --> VECTOR
    AGENT --> EMBEDDING
    SERVICE --> CACHE

    %% Styling
    classDef ui fill:#e3f2fd
    classDef processing fill:#f3e5f5
    classDef ai fill:#fff3e0
    classDef knowledge fill:#e8f5e8
    classDef support fill:#fce4ec
    
    class UI,TEMPLATES,CHAT ui
    class CONTROLLER,SERVICE,AGENT processing
    class PHI3,ANALYSIS,GENERATION ai
    class QURAN,HADITH,FIQH,SCHOLARS knowledge
    class VECTOR,EMBEDDING,CACHE support
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#3498db',
                primaryTextColor: '#2c3e50',
                primaryBorderColor: '#2980b9',
                lineColor: '#34495e',
                secondaryColor: '#ecf0f1',
                tertiaryColor: '#bdc3c7'
            }
        });
    </script>
</body>
</html>
